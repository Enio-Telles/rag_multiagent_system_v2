# üè¢ Sistema de Bancos de Dados por Empresa - Documenta√ß√£o Completa

## üìã **VIS√ÉO GERAL**

Sistema avan√ßado que cria bancos de dados SQLite separados para cada empresa, mantendo classifica√ß√µes, descri√ß√µes enriquecidas, justificativas de agentes e hist√≥rico completo de consultas. O Golden Set permanece como refer√™ncia compartilhada entre todas as empresas.

## üèóÔ∏è **ARQUITETURA DO SISTEMA**

### **Estrutura de Bancos**
```
data/
‚îú‚îÄ‚îÄ empresas/
‚îÇ   ‚îú‚îÄ‚îÄ empresa_1.db     # Banco da empresa 1
‚îÇ   ‚îú‚îÄ‚îÄ empresa_2.db     # Banco da empresa 2
‚îÇ   ‚îî‚îÄ‚îÄ empresa_N.db     # Banco da empresa N
‚îî‚îÄ‚îÄ golden_set_shared.db # Golden Set compartilhado
```

### **Tabelas por Empresa**
Cada banco de empresa cont√©m 7 tabelas principais:

#### 1Ô∏è‚É£ **empresa_info**
```sql
- id, nome, cnpj, tipo_atividade
- descricao_atividade, canal_venda
- porte_empresa, regime_tributario
- segmento_cest_preferencial
- data_criacao, data_atualizacao
```

#### 2Ô∏è‚É£ **produtos_empresa**
```sql
- id, gtin, nome_produto
- descricao_original, descricao_enriquecida
- categoria, marca, peso, unidade_medida, preco
- data_cadastro, data_atualizacao, ativo
```

#### 3Ô∏è‚É£ **classificacoes**
```sql
- id, produto_id, ncm_codigo, ncm_descricao
- cest_codigo, cest_descricao
- confianca_ncm, confianca_cest
- status (pendente/aprovado/rejeitado/revisao)
- aprovado_por, data_classificacao, data_aprovacao
- observacoes
```

#### 4Ô∏è‚É£ **agente_acoes**
```sql
- id, produto_id, classificacao_id
- agente_nome (expansion/ncm/cest/aggregation/reconciler)
- acao_tipo (busca/classificacao/validacao/correcao)
- input_dados (JSON), output_resultado (JSON)
- justificativa, confianca, tempo_execucao
- data_execucao, sucesso, erro_detalhes
```

#### 5Ô∏è‚É£ **agente_consultas**
```sql
- id, produto_id, agente_nome
- tipo_consulta (semantic_search/database_lookup/api_call)
- query_original, query_processada
- resultados_encontrados, resultado_detalhes (JSON)
- relevancia_score, tempo_resposta
- data_consulta, sucesso
```

#### 6Ô∏è‚É£ **historico_mudancas**
```sql
- id, produto_id, classificacao_id
- tipo_mudanca (criacao/atualizacao/aprovacao/rejeicao)
- campo_alterado, valor_anterior, valor_novo
- usuario, motivo, data_mudanca
```

#### 7Ô∏è‚É£ **metricas_performance**
```sql
- id, data_calculo
- total_produtos, total_classificacoes
- aprovacoes_automaticas, aprovacoes_manuais, rejeicoes
- tempo_medio_classificacao
- confianca_media_ncm, confianca_media_cest
- produtos_golden_set, taxa_sucesso
- dados_detalhados (JSON)
```

### **Golden Set Compartilhado**
Banco separado com tabelas:

#### **golden_set_produtos**
```sql
- id, gtin, nome_produto, descricao_padronizada
- ncm_codigo, ncm_descricao, cest_codigo, cest_descricao
- categoria_padrao, subcategoria
- confianca_validacao, origem_validacao
- numero_validacoes, data_criacao, data_atualizacao
- ativo, observacoes
```

#### **golden_set_validacoes**
```sql
- id, produto_golden_id, empresa_origem_id
- validador, tipo_validacao (manual/automatica)
- confianca, observacoes, data_validacao
```

## üîß **COMPONENTES IMPLEMENTADOS**

### **1. EmpresaDatabaseManager**
**Arquivo**: `src/database/empresa_database_manager.py`

Responsabilidades:
- ‚úÖ Criar bancos SQLite por empresa
- ‚úÖ Gerenciar estrutura de tabelas
- ‚úÖ Inserir produtos e classifica√ß√µes
- ‚úÖ Rastrear a√ß√µes e consultas de agentes
- ‚úÖ Manter Golden Set compartilhado
- ‚úÖ Gerar estat√≠sticas e relat√≥rios

**M√©todos principais:**
```python
create_empresa_database(empresa_id, empresa_info)
insert_produto(empresa_id, produto_data)
insert_classificacao(empresa_id, produto_id, classificacao_data)
insert_agente_acao(empresa_id, acao_data)
insert_agente_consulta(empresa_id, consulta_data)
get_empresa_stats(empresa_id)
get_produto_detalhado(empresa_id, produto_id)
```

### **2. EmpresaClassificacaoService**
**Arquivo**: `src/services/empresa_classificacao_service.py`

Responsabilidades:
- ‚úÖ Integrar classifica√ß√£o com bancos segregados
- ‚úÖ Rastrear a√ß√µes dos agentes durante classifica√ß√£o
- ‚úÖ Aprovar/rejeitar classifica√ß√µes
- ‚úÖ Adicionar produtos ao Golden Set
- ‚úÖ Gerar relat√≥rios empresariais

**M√©todos principais:**
```python
inicializar_empresa(empresa_data)
classificar_produto_empresa(empresa_id, produto_data, hybrid_router)
aprovar_classificacao(empresa_id, classificacao_id, usuario, observacoes)
rejeitar_classificacao(empresa_id, classificacao_id, usuario, motivo)
adicionar_ao_golden_set(empresa_id, produto_id, usuario)
get_relatorio_empresa(empresa_id)
```

### **3. API Endpoints**
**Arquivo**: `src/api/empresa_database_api.py`

**Endpoints dispon√≠veis:**

#### **üè¢ Gest√£o de Empresas**
- `POST /api/v1/empresa-db/inicializar` - Criar nova empresa
- `GET /api/v1/empresa-db/empresas` - Listar todas empresas
- `GET /api/v1/empresa-db/empresas/{id}/stats` - Estat√≠sticas da empresa
- `GET /api/v1/empresa-db/empresas/{id}/relatorio` - Relat√≥rio completo

#### **üì¶ Gest√£o de Produtos**
- `POST /api/v1/empresa-db/empresas/{id}/produtos` - Classificar produto
- `GET /api/v1/empresa-db/empresas/{id}/produtos` - Listar produtos
- `GET /api/v1/empresa-db/empresas/{id}/produtos/{produto_id}` - Detalhes do produto

#### **‚úÖ Gest√£o de Classifica√ß√µes**
- `POST /api/v1/empresa-db/empresas/{id}/classificacoes/{class_id}/aprovar` - Aprovar classifica√ß√£o
- `POST /api/v1/empresa-db/empresas/{id}/classificacoes/{class_id}/rejeitar` - Rejeitar classifica√ß√£o

#### **üèÜ Golden Set**
- `POST /api/v1/empresa-db/empresas/{id}/produtos/{produto_id}/golden-set` - Adicionar ao Golden Set
- `GET /api/v1/empresa-db/golden-set` - Listar Golden Set
- `GET /api/v1/empresa-db/golden-set/{id}/validacoes` - Valida√ß√µes do Golden Set

#### **üìä Analytics**
- `GET /api/v1/empresa-db/empresas/{id}/agentes/performance` - Performance dos agentes

## üöÄ **COMO USAR**

### **1. Inicializar Sistema**
```bash
# Testar sistema completo
python test_sistema_bancos_empresa.py

# Integrar endpoints na API
python integrar_endpoints_banco_empresa.py
```

### **2. Criar Nova Empresa**
```bash
curl -X POST "http://localhost:8000/api/v1/empresa-db/inicializar" \
     -H "Content-Type: application/json" \
     -d '{
       "nome": "COSM√âTICOS PORTA A PORTA LTDA",
       "cnpj": "12.345.678/0001-90",
       "tipo_atividade": "Comercio varejista porta a porta",
       "descricao_atividade": "Venda de cosm√©ticos em domic√≠lio",
       "canal_venda": "porta_a_porta",
       "porte_empresa": "EPP",
       "regime_tributario": "SIMPLES_NACIONAL"
     }'
```

### **3. Classificar Produto**
```bash
curl -X POST "http://localhost:8000/api/v1/empresa-db/empresas/1/produtos" \
     -H "Content-Type: application/json" \
     -d '{
       "nome_produto": "Batom Vermelho Matte",
       "descricao_original": "Batom de longa dura√ß√£o",
       "categoria": "Cosm√©ticos",
       "marca": "BeautyBrand",
       "preco": 29.90
     }'
```

### **4. Aprovar Classifica√ß√£o**
```bash
curl -X POST "http://localhost:8000/api/v1/empresa-db/empresas/1/classificacoes/1/aprovar" \
     -H "Content-Type: application/json" \
     -d '{
       "usuario": "revisor@empresa.com",
       "observacoes": "Classifica√ß√£o validada manualmente"
     }'
```

### **5. Obter Relat√≥rio**
```bash
curl -X GET "http://localhost:8000/api/v1/empresa-db/empresas/1/relatorio"
```

## üìä **RASTREAMENTO DE AGENTES**

### **A√ß√µes Rastreadas**
Para cada produto classificado, o sistema registra:

- **ü§ñ Agente**: expansion, ncm, cest, aggregation, reconciler
- **‚ö° A√ß√£o**: busca, classificacao, validacao, correcao
- **üì• Input**: Dados de entrada (JSON)
- **üì§ Output**: Resultado da a√ß√£o (JSON)
- **üí≠ Justificativa**: Explica√ß√£o da decis√£o
- **üéØ Confian√ßa**: Score de confian√ßa
- **‚è±Ô∏è Tempo**: Dura√ß√£o da execu√ß√£o
- **‚úÖ Sucesso**: Status da opera√ß√£o

### **Consultas Rastreadas**
- **üîç Tipo**: semantic_search, database_lookup, api_call
- **üìù Query**: Query original e processada
- **üìä Resultados**: Quantidade e detalhes encontrados
- **üéØ Relev√¢ncia**: Score de relev√¢ncia
- **‚è±Ô∏è Tempo**: Tempo de resposta

## üéØ **BENEF√çCIOS DO SISTEMA**

### **Segrega√ß√£o por Empresa**
- ‚úÖ **Isolamento**: Dados separados por empresa
- ‚úÖ **Performance**: Bancos menores e otimizados
- ‚úÖ **Seguran√ßa**: Acesso controlado por empresa
- ‚úÖ **Backup**: Backup individual por empresa

### **Rastreabilidade Completa**
- ‚úÖ **Auditoria**: Hist√≥rico completo de mudan√ßas
- ‚úÖ **Debug**: Rastreamento de a√ß√µes dos agentes
- ‚úÖ **Analytics**: M√©tricas de performance
- ‚úÖ **Compliance**: Justificativas para todas as decis√µes

### **Golden Set Centralizado**
- ‚úÖ **Refer√™ncia**: Base comum para todas empresas
- ‚úÖ **Qualidade**: Produtos validados e aprovados
- ‚úÖ **Aprendizado**: Melhoria cont√≠nua do sistema
- ‚úÖ **Consenso**: Valida√ß√µes de m√∫ltiplas empresas

### **APIs Robustas**
- ‚úÖ **RESTful**: Endpoints padronizados
- ‚úÖ **Documenta√ß√£o**: Swagger/OpenAPI integrado
- ‚úÖ **Valida√ß√£o**: Modelos Pydantic
- ‚úÖ **Tratamento**: Erros bem estruturados

## üìà **M√âTRICAS E RELAT√ìRIOS**

### **Estat√≠sticas por Empresa**
- Total de produtos cadastrados
- Total de classifica√ß√µes realizadas
- Taxa de aprova√ß√£o/rejei√ß√£o
- Confian√ßa m√©dia NCM/CEST
- Performance por agente
- Tempo m√©dio de classifica√ß√£o

### **Relat√≥rios Dispon√≠veis**
- Relat√≥rio geral da empresa
- Performance dos agentes
- Hist√≥rico de classifica√ß√µes
- Produtos no Golden Set
- Auditoria de mudan√ßas

## üîÆ **PR√ìXIMOS PASSOS**

### **Melhorias Planejadas**
- [ ] Dashboard web para visualiza√ß√£o
- [ ] Relat√≥rios em PDF/Excel
- [ ] Sistema de notifica√ß√µes
- [ ] Backup autom√°tico dos bancos
- [ ] Sincroniza√ß√£o entre empresas
- [ ] Machine Learning para sugest√µes
- [ ] API de importa√ß√£o/exporta√ß√£o
- [ ] Sistema de usu√°rios por empresa

### **Integra√ß√µes Futuras**
- [ ] ERP empresariais
- [ ] Sistemas de e-commerce
- [ ] APIs de √≥rg√£os fiscais
- [ ] Plataformas de BI
- [ ] Sistemas de auditoria

---

## üìù **CONCLUS√ÉO**

O sistema de bancos de dados por empresa oferece:

‚úÖ **Segrega√ß√£o completa** de dados por empresa
‚úÖ **Rastreabilidade total** das a√ß√µes dos agentes
‚úÖ **Golden Set centralizado** para refer√™ncia
‚úÖ **APIs robustas** para integra√ß√£o
‚úÖ **Relat√≥rios detalhados** para gest√£o
‚úÖ **Performance otimizada** com SQLite
‚úÖ **Escalabilidade** para m√∫ltiplas empresas

**üöÄ Sistema pronto para produ√ß√£o com arquitetura escal√°vel e funcionalidades avan√ßadas!**
